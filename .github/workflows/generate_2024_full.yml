name: Generate 2024 Excel and CSV from 2023 templates

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install deps
      run: |
        pip install pandas openpyxl pdfplumber python-dateutil

    - name: Generate 2024 outputs
      run: |
        python <<'PY'
        import os, re, json, sys
        from pathlib import Path
        import pandas as pd
        import pdfplumber
        from dateutil.parser import parse as dparse
        from openpyxl import load_workbook, Workbook

        ROOT = Path(".")
        DATA = ROOT/"data_2024"
        TEMPL = ROOT/"examples_2023_split"
        ANALYTICS_SRC = ROOT/"examples_2023_analysis"/"b. File Excel con elaborazione dei dati contenuti nell allegato di cui al punto a.csv"
        OUT = ROOT/"output_2024"
        OUT.mkdir(exist_ok=True)

        # ---------- helpers ----------
        IT_MONTHS = ["GENNAIO","FEBBRAIO","MARZO","APRILE","MAGGIO","GIUGNO","LUGLIO","AGOSTO","SETTEMBRE","OTTOBRE","NOVEMBRE","DICEMBRE"]
        MONTH_MAP = {m:i+1 for i,m in enumerate(IT_MONTHS)}

        def guess_month_from_pdfname(name:str)->int|None:
          m = re.search(r"([A-ZÀ-Ù]+)_?2024", name.upper())
          if m:
            key = m.group(1).replace("_","")
            return MONTH_MAP.get(key)
          return None

        def normalize_date(x):
          if pd.isna(x): return None
          try:
            dt = dparse(str(x), dayfirst=True, yearfirst=False, fuzzy=True)
            return pd.Timestamp(dt.date())
          except Exception:
            return None

        # ---------- 1) read the SINGLE CSV ----------
        csv_candidates = list(DATA.glob("report*.csv")) + list(DATA.glob("*.csv"))
        csv_path = None
        for c in csv_candidates:
          if "report" in c.name.lower():
            csv_path = c; break
        if csv_path is None:
          raise SystemExit("report (29).csv non trovato in data_2024/")

        df_csv = pd.read_csv(csv_path)
        # prova ad indovinare colonne tipiche
        # cerchiamo una colonna data
        date_col = None
        for c in df_csv.columns:
          if re.search(r"^date$|data|giorno", str(c).lower()):
            date_col = c; break
        if date_col is None:
          # se non esiste, prova a comporre una data da colonne note (fallback)
          pass

        # normalizza date e aggiungi mese
        if date_col is not None:
          df_csv["__DATE__"] = df_csv[date_col].apply(normalize_date)
        else:
          df_csv["__DATE__"] = pd.NaT

        df_csv["__MONTH__"] = df_csv["__DATE__"].dt.month
        # ---------- 2) integrate from PDFs for missing days ----------
        # costruiamo un dataframe "events_2024" con almeno: DATE, CODE, DESC, DEP, ARR, ecc. (se disponibili)
        # useremo le colonne del CSV come base; dai PDF estraiamo tabelle e uniamo righe mancanti per mese

        events = df_csv.copy()

        pdfs = sorted(DATA.glob("*_2024.pdf"))
        for pdf in pdfs:
          mnum = guess_month_from_pdfname(pdf.name)
          if not mnum: 
            continue
          # estrai tabelle con pdfplumber
          rows = []
          try:
            with pdfplumber.open(pdf) as doc:
              for p in doc.pages:
                for tbl in p.extract_tables() or []:
                  # prima riga spesso header
                  hdr = [str(h).strip() if h is not None else "" for h in tbl[0]]
                  for r in tbl[1:]:
                    row = {hdr[i] if i < len(hdr) else f"COL{i+1}": (str(r[i]).strip() if i < len(r) and r[i] is not None else "") for i in range(max(len(hdr),len(r)))}
                    rows.append(row)
          except Exception as e:
            print(f"[WARN] PDF {pdf.name}: {e}")

          if not rows:
            continue
          pdf_df = pd.DataFrame(rows)
          # prova a individuare colonna data
          pdf_date_col = None
          for c in pdf_df.columns:
            if re.search(r"^date$|data|giorno", c.lower()):
              pdf_date_col = c; break

          if pdf_date_col:
            pdf_df["__DATE__"] = pdf_df[pdf_date_col].apply(normalize_date)
            pdf_df["__MONTH__"] = pdf_df["__DATE__"].dt.month
            pdf_df = pdf_df[pdf_df["__MONTH__"]==mnum]
            # Uniamo solo le righe con date mancanti nel CSV per quel mese
            if "__DATE__" in events.columns:
              existing_dates = set(events.loc[events["__MONTH__"]==mnum,"__DATE__"].dropna().unique())
              add_pdf = pdf_df[~pdf_df["__DATE__"].isin(existing_dates)]
              if len(add_pdf):
                # uniforma colonne presenti
                for col in add_pdf.columns:
                  if col not in events.columns:
                    events[col] = pd.NA
                events = pd.concat([events, add_pdf[events.columns]], ignore_index=True)
          # altrimenti, non sappiamo associare
        # ---------- 3) per ogni template, produce Excel 2024 ----------
        def fill_template(template_path:Path, target_path:Path, month:int|None):
          wb = load_workbook(template_path)
          ws = wb.active
          # trova riga header cercando "DATA" o "DATE"
          header_row = None
          max_scan = 15
          for r in range(1, max_scan+1):
            values = [str(ws.cell(r,c).value).strip().upper() if ws.cell(r,c).value is not None else "" for c in range(1, 20)]
            if any(x in values for x in ["DATA","DATE"]):
              header_row = r; break
          if header_row is None:
            header_row = 1
          # costruisci dataframe filtrato per mese (se il file è mensile)
          df = events.copy()
          if month:
            df = df[df["__MONTH__"]==month]
          # se non abbiamo una mappatura colonne precisa, scriviamo le colonne del CSV nell'ordine
          # posizionandole dalla colonna A sotto l'header
          start_row = header_row + 1
          # pulisci le righe esistenti sotto l'header (senza toccare formule fuori tabella)
          # limite 1000 righe
          for r in range(start_row, start_row+1000):
            for c in range(1, df.shape[1]+1):
              ws.cell(r,c).value = None
          # scrivi header dei dati consolidati (per tracciabilità) mantenendo l'header originale in Excel
          # scriviamo solo i valori dalla riga start_row
          vals = df.fillna("").astype(str).values.tolist()
          for i,row in enumerate(vals, start_row):
            for j,val in enumerate(row, 1):
              ws.cell(i,j).value = val
          wb.save(target_path)

        for tpl in sorted(TEMPL.glob("*.xlsx")):
          name = tpl.name
          # mappa mese dal nome file, se presente
          mm = None
          for it_name,num in MONTH_MAP.items():
            if it_name in name.upper():
              mm = num; break
          out_name = name.replace("2023","2024")
          target = OUT/out_name
          fill_template(tpl, target, mm)

        # ---------- 4) genera CSV di analisi 2024 con stesso schema ----------
        if ANALYTICS_SRC.exists():
          schema = pd.read_csv(ANALYTICS_SRC, nrows=0).columns.tolist()
          df_out = events.copy()
          # crea colonne mancanti e ordina come schema
          for col in schema:
            if col not in df_out.columns:
              df_out[col] = pd.NA
          df_out = df_out[schema]
          df_out.to_csv(OUT/"b. File Excel con elaborazione dei dati contenuti nell allegato di cui al punto a.csv", index=False, encoding="utf-8-sig")

        # ---------- 5) trace log ----------
        def month_count(m): 
          return int(events[events["__MONTH__"]==m].shape[0])
        with open(OUT/"TRACE_2024.md","w",encoding="utf-8") as f:
          f.write("# TRACE 2024\n\n")
          f.write(f"CSV sorgente: {csv_path.name}\n\n")
          for m,it in MONTH_MAP.items():
            f.write(f"- {m}: {month_count(it)} righe consolidate\n")
          f.write("\nPDF letti:\n")
          for p in pdfs:
            f.write(f"- {p.name}\n")
        print("DONE")
        PY
            - name: Commit and push updated 2024 files
      run: |
        git config user.name "GitHub Action"
        git config user.email "actions@github.com"
        git add output_2024/*
        git commit -m "Update generated 2024 Excel files" || echo "No changes to commit"
        git push origin main

